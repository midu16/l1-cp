# Increase Retention Period for Logs in OpenShift 4.

## Introduction
The main use case of Telco is to keep logs persisted locally, instead of utilizing a log forwarder and a log store. Logs will be retrieved (pull mode) ad-hoc by an external tool. The partner requires at least **14 days of retention period** for all logs retrieved by the log collector and any troubleshooting tool, such as `sos-report` and `must-gather`.

By default, the log collector uses the following sources:
- System and infrastructure logs generated by `journald`.
- `/var/log/containers/*.log` for all container logs.
- `/var/log/audit/audit.log` for audit logs.

The proposed solution does **NOT** include any logs produced by workloads that are stored in PVs.

---

## Configuration
Since CoreOS is immutable, all configuration changes on CoreOS should be implemented via custom resources, like `MachineConfig` or `KubeletConfig`.

### Journal Logs
We can use `MaxRetentionSec` in `journald.conf` to enforce the retention policies for journal logs in `/var/log/journal`. However, there are other parameters to limit the size of journal logs, such as:
- `SystemMaxUse`
- `SystemMaxFileSize`
- `SystemMaxFiles`

#### Parameters to Adjust:

| Name                | Description                                                               | Default Value       | Capped Value |
|---------------------|---------------------------------------------------------------------------|---------------------|--------------|
| `MaxRetentionSec`   | The maximum time to store journal entries. Older entries will be deleted. | `0`                 | `14days`     |
| `SystemMaxUse`      | Controls the maximum disk space for journal logs.                         | 10% of filesystem   | `4G`         |
| `SystemMaxFileSize` | Maximum size for individual journal files.                                | `â…› of SystemMaxUse` | `128M`       |
| `SystemMaxFiles`    | Maximum number of journal files to keep.                                  | `100`               | -            |

For detailed information regarding systemd settings, refer to [OpenShift Documentation](https://docs.openshift.com/container-platform/4.14/logging/config/cluster-logging-systemd.html).

#### Create a Butane Config File
```sh
cat <<EOF > 40-master-custom-journald.bu
variant: openshift
version: 4.14.0
metadata:
  name: 40-master-custom-journald
  labels:
    machineconfiguration.openshift.io/role: "master"
storage:
  files:
  - path: /etc/systemd/journald.conf
    mode: 0644
    overwrite: true
    contents:
      inline: |
        MaxRetentionSec=14day
        SystemMaxUse=4G
EOF
```
> **Note:** This operation will overwrite the current `journald.conf` file.

#### Generate a MachineConfig File
```sh
butane 40-master-custom-journald.bu -o 40-master-custom-journald.yaml
```

#### Apply the Machine Config
```sh
oc apply -f 40-master-custom-journald.yaml
```

---

## Container Logs
There is no parameter to directly control the retention period for container logs. However, we can estimate the total log size for 14 days and adjust the log size settings accordingly.

#### Parameters to Adjust:

| Name                   | Description                                | Default Value | New Value |
|------------------------|--------------------------------------------|---------------|-----------|
| `containerLogMaxSize`  | Maximum size of each log file in container | `50Mi`        | `100Mi`   |
| `containerLogMaxFiles` | Maximum number of log files in container   | `5`           | `10`      |

> **Note:** New values need to be calculated based on CNF container logs.

#### Create a `KubeletConfig` Custom Resource
```sh
cat <<EOF > kubeletconfig.yaml
apiVersion: machineconfiguration.openshift.io/v1
kind: KubeletConfig
metadata:
  name: log-config
spec:
  machineConfigPoolSelector:
    matchLabels:
      custom-kubelet: enabled
  kubeletConfig:
    containerLogMaxSize: 100Mi
    containerLogMaxFiles: 10
EOF
```

#### Apply the KubeletConfig
```sh
oc apply -f kubeletconfig.yaml
```

---

## Audit Logs
We can adjust parameters in `/etc/audit/auditd.conf` to satisfy the retention period for audit logs.

#### Parameters to Adjust:

| Name                  | Description                          | Default Value | New Value |
|-----------------------|--------------------------------------|---------------|-----------|
| `max_log_file`        | Maximum size of each log file in MB  | `8`           | `8`       |
| `max_log_file_action` | Action when max file size is reached | `ROTATE`      | `ROTATE`  |
| `num_logs`            | Number of log files to keep          | `5`           | `10`      |

#### Create a Butane Config File
```sh
cat <<EOF > 40-master-custom-auditd.bu
variant: openshift
version: 4.14.0
metadata:
  name: 40-master-custom-auditd
  labels:
    machineconfiguration.openshift.io/role: "master"
storage:
  files:
  - path: /etc/audit/auditd.conf
    mode: 0640
    overwrite: true
    contents:
      inline: |
        local_events = yes
        write_logs = yes
        log_file = /var/log/audit/audit.log
        log_group = root
        log_format = ENRICHED
        flush = INCREMENTAL_ASYNC
        freq = 50
        max_log_file = 8
        num_logs = 10
        priority_boost = 4
        name_format = NONE
        max_log_file_action = ROTATE
        space_left = 75
        space_left_action = SYSLOG
        verify_email = yes
        action_mail_acct = root
        admin_space_left = 50
        admin_space_left_action = SUSPEND
        disk_full_action = SUSPEND
        disk_error_action = SUSPEND
        use_libwrap = yes
        overflow_action = SYSLOG
        max_restarts = 10
EOF
```

#### Generate a MachineConfig File
```sh
butane 40-master-custom-auditd.bu -o 40-master-custom-auditd.yaml
```

#### Apply the Machine Config
```sh
oc apply -f 40-master-custom-auditd.yaml
```


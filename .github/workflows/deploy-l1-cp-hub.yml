name: deploy-l1-cp-hub

permissions:
  contents: read

concurrency:
  group: deploy-l1-cp-hub
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      ocp_version:
        description: "OpenShift version (e.g., 4.18.27)"
        required: true
        default: "4.18.27"
      registry_url:
        description: "AirGapped Registry URL"
        required: true
        default: "infra.5g-deployment.lab:8443"
      remote_host:
        description: "Remote host for seed VM (optional)"
        required: false
        default: ""
      vm_name:
        description: "Seed VM name (optional)"
        required: false
        default: "sno1"

defaults:
  run:
    shell: bash

env:
  OCP_VERSION: ${{ github.event.inputs.ocp_version }}
  REGISTRY_URL: ${{ github.event.inputs.registry_url }}
  REMOTE_HOST: ${{ github.event.inputs.remote_host }}
  VM_NAME: ${{ github.event.inputs.vm_name }}
  KUBECONFIG_PATH: ${{ github.workspace }}/hub/auth/kubeconfig

jobs:

  clean-hub:
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 30
    env:
      REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
      REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

    steps:
      - name: üßπ Fix workspace ownership (prevents EACCES)
        run: |
          sudo chown -R $(whoami):$(whoami) "${GITHUB_WORKSPACE}/"

      - uses: actions/checkout@v4
        with:
          repository: midu16/l1-cp
          token: ${{ secrets.GITHUB_TOKEN }}
          clean: true
          persist-credentials: true
          fetch-depth: 1
          fetch-tags: false
          submodules: false
          lfs: false
          set-safe-directory: true

      - name: üßπ Safe workspace cleanup (extra precaution)
        run: |
          git -C "${GITHUB_WORKSPACE}/l1-cp" reset --hard || true
          git -C "${GITHUB_WORKSPACE}/l1-cp" clean -fdx || true

      - name: üóëÔ∏è Clean up previous RHACM Virtual Hub
        run: sudo kcli delete plan hub -y

      - name: üóëÔ∏è Clean up old registry content
        run: sudo rm -rf /home/registry/data/docker || true

      - name: üîÑ Restart podman-registry
        run: |
          sudo systemctl restart podman-registry.service
          sudo systemctl status podman-registry.service || true

      - name: üßπ Remove remote Seed VM (if provided)
        if: env.REMOTE_HOST != ''
        run: |
          REMOTE="${REMOTE_HOST}"
          VM="${VM_NAME}"
          SSH_TIMEOUT=30

          echo "Cleaning Seed VM: $VM on $REMOTE"

          if ! timeout $SSH_TIMEOUT ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 "$REMOTE" true 2>/dev/null; then
            echo "‚ö†Ô∏è Could not SSH to $REMOTE ‚Äî skipping VM cleanup"
            exit 0
          fi

          if ssh "$REMOTE" "kcli list vm | grep -q '^$VM'"; then
            echo "Deleting VM $VM ..."
            ssh "$REMOTE" "kcli delete vm $VM -y" || true
          else
            echo "‚ÑπÔ∏è VM $VM not found on remote host"
          fi

  build-hub:
    runs-on: [self-hosted, linux, x64]
    timeout-minutes: 180
    needs: clean-hub
    env:
      REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
      REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
      REPO_PATH: ${{ github.workspace }}

    steps:
      - uses: actions/checkout@v4

      - name: üì• Download OCP tools
        run: sudo make download-oc-tools VERSION="${OCP_VERSION}"

      - name: üìù Render imageset-config.yml
        run: sudo make imageset-config.yml OCP_VERSION="${OCP_VERSION}"

      - name: üîç Validate AirGapped registry catalog
        run: |
          curl -sk -u "${REGISTRY_USERNAME}:${REGISTRY_PASSWORD}" \
            "https://${REGISTRY_URL}/v2/_catalog" | jq . || echo "‚ö†Ô∏è Registry check failed"

      - name: ‚öôÔ∏è Prepare install-config
        run: |
          sudo make fetch-certificate REGISTRY_URL="${REGISTRY_URL}"
          sudo make registry-pull-secret USERNAME="${REGISTRY_USERNAME}" PASSWORD="${REGISTRY_PASSWORD}" REGISTRY_URL="${REGISTRY_URL}"
          sudo make update-sshkey SSHKEY_FILE="/root/.ssh/id_rsa.pub"

      - name: üì¶ Mirror images to AirGapped registry
        run: |
          sudo DOCKER_CONFIG=/root/.docker ./bin/oc-mirror -c imageset-config.yml --v2 \
            --workspace file://hub-demo/ \
            docker://"${REGISTRY_URL}"/hub-demo \
            --max-nested-paths 10 --parallel-images 10 --parallel-layers 10 \
            --dest-tls-verify=false --log-level debug

      - name: üîß Generate openshift-install binary
        run: sudo make generate-openshift-install \
          RELEASE_IMAGE="${REGISTRY_URL}/hub-demo/openshift/release-images:${OCP_VERSION}-x86_64"

      - name: üíø Generate agent ISO
        run: sudo make create-agent-iso

      - name: üì§ Copy agent ISO to webcache
        run: |
          SRC=$(ls hub/agent*.iso | head -n1 || true)
          if [[ -z "$SRC" ]]; then
            echo "‚ùå No agent ISO found"; exit 1
          fi
          sudo cp "$SRC" /opt/webcache/data/agent.x86_64.iso
          echo "‚úÖ Copied $SRC to /opt/webcache/data/"

      - name: üñ•Ô∏è Create Hub VMs
        run: |
          for i in 0 1 2; do
            MAC="aa:aa:aa:aa:01:0$((i+1))"
            UUID="aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaa010$((i+1))"
            sudo kcli create vm \
              -P start=True -P uefi_legacy=true -P plan=hub \
              -P memory=71680 -P numcpus=40 -P disks=[300,100,50] \
              -P nets="[{'name': 'br0', 'mac': '$MAC'}]" \
              -P uuid="$UUID" \
              -P name="hub-ctlplane-$i" \
              -P iso=/opt/webcache/data/agent.x86_64.iso
          done

      - name: ‚è±Ô∏è Wait for installation to complete
        run: sudo ./bin/openshift-install --dir ./hub/ agent wait-for install-complete --log-level=info

      - name: ‚è±Ô∏è Wait for Cluster Operators
        run: sudo oc --kubeconfig="${KUBECONFIG_PATH}" wait --for=condition=Available clusteroperators --all --timeout=1800s

      - name: üö® Validate no degraded operators
        run: |
          degraded=$(sudo oc --kubeconfig="${KUBECONFIG_PATH}" get clusteroperators -o json | jq -r '.items[] | select(.status.conditions[] | select(.type=="Degraded" and .status=="True")) | .metadata.name')
          if [[ -n "$degraded" ]]; then
            echo "‚ùå Degraded operators detected: $degraded"
            exit 1
          fi
          echo "‚úÖ No degraded Operators"

      - name: üìã Print final Operator status
        run: sudo oc --kubeconfig="${KUBECONFIG_PATH}" get clusteroperators
